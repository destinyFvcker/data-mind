name: Build and deploy to aliyun(web server)
on:
    push:
        branches: ["main"]
env:
    CARGO_TERM_COLOR: always
    DEPLOY_PATH: "/home/${{ secrets.ALIYUN_USER }}/projects/data-mind/web-server/"
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build
              run: cargo build -p web_server --release
            # 创建部署目录结构
            - name: Create deployment directory structure
              run: |
                  mkdir -p deployment/conf
                  cp target/release/web_server deployment/
                  cp scripts/restart_web_server.sh deployment/
                  chmod +x deployment/restart_web_server.sh
                  cp -r conf/* deployment/conf/ || echo "No configuration files found"
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: web-server-release
                  path: deployment/
                  compression-level: 9
                  retention-days: 5
    deploy:
        name: Deploy to Aliyun Server
        needs: build
        runs-on: ubuntu-latest
        steps:
            # 下载构建产物
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: web-server-release
                  path: ./deploy-package
            # 部署到阿里云服务器
            - name: Deploy to Aliyun
              uses: easingthemes/ssh-deploy@main
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
                  REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
                  REMOTE_USER: ${{ secrets.ALIYUN_USER }}
                  ARGS: "-avzr --delete --mkpath"
                  SOURCE: "./deploy-package/"
                  TARGET: ${{ env.DEPLOY_PATH }}
            # 重启服务
            - name: Restart service using SSH Remote Commands
              uses: appleboy/ssh-action@v1.2.1
              with:
                  host: ${{ secrets.ALIYUN_HOST }}
                  username: ${{ secrets.ALIYUN_USER }}
                  key: ${{ secrets.ALIYUN_SSH_KEY }}
                  # 设置环境变量并执行脚本
                  script: |
                      cd ${{ env.DEPLOY_PATH }}
                      chmod +x ./restart_web_server.sh
                      ./restart_web_server.sh
                      # 检查退出状态
                      if [ $? -eq 0 ]; then
                          echo "✅ 服务已成功使用restart_web_server.sh重启！"
                      else
                          echo "❌ 服务重启失败，请检查日志！"
                          exit 1
                      fi
